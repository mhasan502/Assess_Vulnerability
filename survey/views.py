import json
from django.utils.safestring import SafeString
from django.http import HttpResponse
from django.shortcuts import render, redirect
from survey.models import Questions, Sections


def SurveyView(request):
    surveys = Questions.objects.all()
    return render(request, 'survey.html', {'data': surveys})


def CreateSurvey(request):
    return render(request, 'create_survey.html')


def AddSection(request):
    section = Sections.objects.all()
    return render(request, 'add_section.html', {'data': section})


def DeleteSection(request, key):
    query = Sections.objects.get(id=key)
    query.delete()
    return redirect('add_section')


def SaveSection(request):
    title = request.POST.get('title')
    details = request.POST.get('details')
    section = Sections.objects.create(title=title, details=details)
    section.save()
    return HttpResponse('')


def EditSurvey(request, key):
    query = Questions.objects.get(id=key)
    json_data = json.dumps(query.json)
    json_data = json_data[12:-2]
    query.token = "'{}'".format(query.token)
    data = {
        'query': SafeString(json_data),
        'token': SafeString(query.token),
    }
    return render(request, 'edit_survey.html', data)


def DeleteSurvey(request, key):
    query = Questions.objects.get(id=key)
    query.delete()
    return redirect('survey')


def SaveSurvey(request):
    value = request.POST.get('data')
    data = json.loads(value.encode().decode('utf-8'))
    token = request.POST.get('token')
    title = request.POST.get('title')
    section_id = request.POST.get('section')
    section = Sections.objects.get(id=section_id)

    try:
        check_if_exists = Questions.objects.get(token=token)
        check_if_exists.title = title
        check_if_exists.section = section
        check_if_exists.json = data
        check_if_exists.save(update_fields=['title', 'section', 'json'])
        print('saved')

    except Exception:
        questions = Questions.objects.create(
            title=title,
            section=section,
            json=data,
            token=token
        )
        questions.save()

    return HttpResponse('')
