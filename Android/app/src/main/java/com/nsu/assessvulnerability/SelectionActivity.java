package com.nsu.assessvulnerability;

import android.content.Intent;
import android.os.Bundle;
import android.view.View;
import android.widget.AdapterView;
import android.widget.Button;
import android.widget.EditText;
import android.widget.Spinner;
import android.widget.Toast;

import androidx.appcompat.app.AppCompatActivity;

import org.json.JSONException;
import org.json.JSONObject;

import java.util.ArrayList;
import java.util.List;

public class SelectionActivity extends AppCompatActivity {


    static SelectionAdapter selectionAdapter;
    static List<PlaceList> unionList = new ArrayList<>();
    static List<PlaceList> upazilaList = new ArrayList<>();
    static List<PlaceList> districtList = new ArrayList<>();
    private Spinner districtSpinner, upazilaSpinner, unionSpinner;
    private EditText userName, userPhone, userNID;
    private Button registerButton;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_selection);

        userName = findViewById(R.id.user_name);
        userPhone = findViewById(R.id.user_phone);
        userNID = findViewById(R.id.user_nid);

        districtSpinner = findViewById(R.id.district);
        upazilaSpinner = findViewById(R.id.upazila);
        unionSpinner = findViewById(R.id.union);

        registerButton = findViewById(R.id.register_button);

        loadDistrict();

    }

    private void loadDistrict() {
        districtList.clear();
        districtList.add(new PlaceList(0, "Select District"));
        String districtURL = "https://assess-vulnerability.com/api/district";
        new SelectionFetchData(this, "District").execute(districtURL);
        selectionAdapter = new SelectionAdapter(this, districtList) {
            @Override
            public boolean isEnabled(int position) {
                return position != 0;
            }
        };
        districtSpinner.setAdapter(selectionAdapter);


        districtSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {
            @Override
            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                PlaceList selectedDistrict = (PlaceList) parent.getSelectedItem();
                loadUpazila(selectedDistrict);
            }

            @Override
            public void onNothingSelected(AdapterView<?> parent) {
                Toast.makeText(getApplicationContext(), "Please Select", Toast.LENGTH_SHORT).show();
            }
        });
    }

    private void loadUpazila(PlaceList selectedDistrict) {
        upazilaList.clear();
        upazilaList.add(new PlaceList(0, "Select Upazila"));
        String upazilaURL = "https://assess-vulnerability.com/api/upazila/" + selectedDistrict.getId();
        new SelectionFetchData(this, "Upazila").execute(upazilaURL);


        selectionAdapter = new SelectionAdapter(this, upazilaList) {
            @Override
            public boolean isEnabled(int position) {
                return position != 0;
            }
        };
        upazilaSpinner.setAdapter(selectionAdapter);
        upazilaSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {
            @Override
            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                PlaceList selectedUpazila = (PlaceList) parent.getSelectedItem();
                loadUnion(selectedUpazila, selectedDistrict);
            }

            @Override
            public void onNothingSelected(AdapterView<?> parent) {

            }
        });
    }

    private void loadUnion(PlaceList selectedUpazila, PlaceList selectedDistrict) {
        unionList.clear();
        unionList.add(new PlaceList(0, "Select Union"));
        String unionURL = "https://assess-vulnerability.com/api/union/" + selectedUpazila.getId();
        new SelectionFetchData(this, "Union").execute(unionURL);


        selectionAdapter = new SelectionAdapter(this, unionList) {
            @Override
            public boolean isEnabled(int position) {
                return position != 0;
            }
        };
        unionSpinner.setAdapter(selectionAdapter);
        unionSpinner.setOnItemSelectedListener(new AdapterView.OnItemSelectedListener() {
            @Override
            public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {
                PlaceList selectedUnion = (PlaceList) parent.getSelectedItem();

                registerButton.setOnClickListener(v -> {
                    boolean locationChecker = (selectedDistrict.getId() != 0) && (selectedUpazila.getId() != 0) && (selectedUnion.getId() != 0);
                    boolean userInfoChecker = (userName.getText().toString().isEmpty()) || (userPhone.getText().toString().isEmpty()) || (userNID.getText().toString().isEmpty());

                    if (locationChecker && !userInfoChecker) {
                        JSONObject jsonUser, jsonLocation, jsonObject;

                        jsonUser = new JSONObject();
                        jsonLocation = new JSONObject();
                        jsonObject = new JSONObject();

                        try {
                            jsonUser.put("name", userName.getText().toString());
                            jsonUser.put("phone", userPhone.getText().toString());
                            jsonUser.put("nid", userNID.getText().toString());

                            jsonLocation.put("district", selectedDistrict.toString());
                            jsonLocation.put("upazila", selectedUpazila.toString());
                            jsonLocation.put("union", selectedUnion.toString());

                            jsonObject.put("user", jsonUser);
                            jsonObject.put("location", jsonLocation);
                        } catch (JSONException e) {
                            e.printStackTrace();
                        }
                        postRequest(jsonObject);
                        startActivity(new Intent(getApplicationContext(), SurveyActivity.class));
                    } else
                        Toast.makeText(getApplicationContext(), "Please select all fields", Toast.LENGTH_SHORT).show();
                });
            }

            @Override
            public void onNothingSelected(AdapterView<?> parent) {

            }
        });
    }

    public void postRequest(JSONObject jsonObject) {
        // replace with your host server URI
        String URL = "https://8404605c4cf4.ngrok.io/api/user";


        APICaller apiCaller = new APICaller();
        apiCaller.Submit(URL, jsonObject.toString(), getApplicationContext());
    }
}