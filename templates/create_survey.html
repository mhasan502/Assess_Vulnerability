{% include 'header.html' %}
{% load static %}

<head>
    <link rel="stylesheet" href={% static 'assets/css/vendor.css' %}/>
    <link rel="stylesheet" href={% static 'assets/css/formbuilder.css' %}/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>

<div class="content">
    <div class="single-line add-form ">
        <div style="display: flex">
            <input id="title" style="margin-left: 10px; width: 60%" type="text"
                   placeholder="Add the title of the form here" required>
            <select id="section" name="section" style="padding: 0 15px;margin-top: 10px;height: 50px;margin-left: 5%;"
                    required></select>
            <input id="submit" type="submit" style="margin-left: 10%;margin-right: 10px;width: 15%" value="Save">
        </div>
        <div class="brd c-left">
            <div id='formbuilder'></div>

            <script>
                let title = null;
                let section = null;
                $("#title").change(function () {
                    title = $(this).val();
                });
                $("#section").change(function () {
                    section = $(this).val();
                });
                $(function () {
                    fb = new Formbuilder({
                        selector: '#formbuilder',
                        bootstrapData: []
                    });
                    let datas = null;
                    fb.on('save', function (payload) {
                        console.log(payload);
                        datas = payload;
                    });

                    $("#submit").click(function () {
                        if (title == null || section == null)
                            alert('Fill all the fields');
                        else {
                            $.ajax({
                                url: {% url 'save_survey' %},
                                method: 'POST',
                                data: {
                                    'title': title,
                                    'section': section,
                                    'data': datas,
                                    'token': window.CSRF_TOKEN,
                                    csrfmiddlewaretoken: window.CSRF_TOKEN,
                                },
                                success: function () {
                                    alert('Saved');
                                },
                                error: function (jqXHR, exception) {
                                    alert(exception + " " + jqXHR.status+'\n'+"Please Try Again");
                                }
                            });
                        }
                    })
                });
            </script>
        </div>
    </div>
</div>

{% block javascript %}
    <script>
        let dropdown1 = $('#section');
        dropdown1.empty();
        dropdown1.append('<option selected="true" disabled>Choose Section</option>');
        dropdown1.prop('selectedIndex', 0);

        let url = '/api/section';
        // Populate dropdown with list of section
        $.getJSON(url, function (data) {
            $.each(data, function (key, entry) {
                dropdown1.append($('<option></option>').attr('value', entry.id).text(entry.title));
            })
        });
    </script>
    <script src={% static 'assets/js/vendor.js' %}></script>
    <script src={% static 'assets/js/formbuilder.js' %}></script>
    <script type="text/javascript"> window.CSRF_TOKEN = "{{ csrf_token }}"; </script>

{% endblock %}