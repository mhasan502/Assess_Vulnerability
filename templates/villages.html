{% include 'header.html' %}
{% load static %}

<div class="content">
    <div class="single-line add-form ">
        <div class="brd c-left">
            <p>Add Villages</p> <br>
            {% csrf_token %}
            <div class="select-holder">
                <select id="district" name="district" required></select>
                <select id="upazila" name="upazila" required></select>
                <select id="union" name="union" required></select>
            </div>
            <input id="village" name="title" type="text" placeholder="Enter village name" required/>
            <input id="submit" type="submit" name="add-village" value="Add"/>
        </div>
    </div>

    {% block javascript %}
        <script>
            let upazila = null;
            let union = null;
            let village = null;

            $("#upazila").change(function () {
                upazila = $(this).val();
            });
            $("#union").change(function () {
                union = $(this).val();
            });
            $("#village").change(function () {
                village = $(this).val();
            });
            $("#submit").click(function () {
                $.ajax({
                    url: 'api/save_village/',
                    data: {
                        'upazila': upazila,
                        'union': union,
                        'village': village
                    },
                    dataType: 'json',
                    success: function (data) {
                        if(data.village_saved)
                            alert("Village Added");
                            window.location.href = ''
                    },
                    error: function (e) {
                        alert("An error ocurred");
                    }
                });
            })
        </script>
    {% endblock %}

    <div class="single-line mt20">
        <div class="">
            <div class="brd c-left list-holder village-list">
                <p>List of Villages</p> <br>

                <table>
                    <tr>
                        <th>Name</th>
                        <th>District</th>
                        <th>Upazila</th>
                        <th>Union</th>
                    </tr>
                    <!--
                                        <?php

                                $list = $db->rawQuery('SELECT villages.id, villages.name,
                                        districts.bn_name as district_name,
                                        upazilas.bn_name as upazila_name,
                                        unionz.bn_name as union_name
                                        FROM villages, districts, upazilas, unions as unionz

                                        WHERE
                                        upazilas.id = villages.upazila_id AND
                                        districts.id = upazilas.district_id AND
                                        unionz.id = villages.union_id');

                                        foreach($list as $item){

                                        echo '
                                        <tr>
                                            <td>'.$item['name'].'</td>
                                            <td>'.$item['district_name'].'</td>
                                            <td>'.$item['upazila_name'].'</td>
                                            <td>'.$item['union_name'].'</td>
                                        </tr>
                                        ';

                                        }
                                        ?>
                    -->
                </table>

            </div>
        </div>
    </div>

</div>

<script>
    let dropdown1 = $('#district');
    dropdown1.empty();
    dropdown1.append('<option selected="true" disabled>Choose districts</option>');
    dropdown1.prop('selectedIndex', 0);

    let url = '/api/district';
    // Populate dropdown with list of provinces
    $.getJSON(url, function (data) {
        $.each(data, function (key, entry) {
            dropdown1.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
        })
    });
    dropdown1.change(function () {
        let selected = $(this).children("option:selected").val();
        let dropdown2 = $('#upazila');
        dropdown2.empty();
        dropdown2.removeAttr('disabled');
        dropdown2.append('<option selected="true" disabled>Choose upazila</option>');
        dropdown2.prop('selectedIndex', 0);

        let url = '/api/upazila/' + selected;
        // Populate dropdown with list of provinces
        $.getJSON(url, function (data) {
            $.each(data, function (key, entry) {
                dropdown2.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
            })
        });

        dropdown2.change(function () {
            let selected2 = $(this).children("option:selected").val();
            let dropdown3 = $('#union');
            dropdown3.empty();
            dropdown3.removeAttr('disabled');
            dropdown3.append('<option selected="true" disabled>Choose union</option>');
            dropdown3.prop('selectedIndex', 0);

            let url = '/api/union/' + selected2;
            // Populate dropdown with list of provinces
            $.getJSON(url, function (data) {
                let ic = 0;
                $.each(data, function (key, entry) {
                    dropdown3.append($('<option></option>').attr('value', entry.id).text(entry.bn_name));
                    ic++;
                });
                if (ic < 1)
                    dropdown3.append('<option selected="true" disabled>No union available</option>');
            });
        });
    });
</script>

<script>
    let dropdown2 = $('#upazila');
    dropdown2.empty();
    dropdown2.attr('disabled', 'disabled');
    dropdown2.append('<option selected="true" disabled>Choose upazila</option>');
    dropdown2.prop('selectedIndex', 0);
</script>

<script>
    let dropdown3 = $('#union');
    dropdown3.empty();
    dropdown3.attr('disabled', 'disabled')
    dropdown3.append('<option selected="true" disabled>Choose union</option>');
    dropdown3.prop('selectedIndex', 0);
</script>
